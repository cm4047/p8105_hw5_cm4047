---
title: "HW5"
author: "Chen Mo"
date: "11/16/2020"
output: github_document
---

```{r setup, include = FALSE}
library(tidyverse)
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

# Problem 1  

First, load the data.  
```{r}
homicide_data = 
        read_csv("./data/homicide-data.csv")
```
The raw data contains `r ncol(homicide_data)` columns and `r nrow(homicide_data)` rows in total. The data provides information of more than 52,000 criminal homicides over past decades in 50 of the largest American cities. The data includes the location of the killing, whether an arrest was made and, in most cases, basic demographic information about each victim.  

Then, clean the data.    
```{r}
homicide_df = 
        homicide_data %>%
        janitor::clean_names() %>% 
        mutate(
                city_state = str_c(city, state, sep = ", "),
                disposition = recode(disposition, "Closed without arrest" = "Unsolved"),
                disposition = recode(disposition, "Open/No arrest" = "Unsolved"),
                disposition = recode(disposition, "Closed by arrest" = "Solved")
        ) %>%
        select(city_state, disposition) %>% 
        filter(city_state != "Tulsa, AL")
```
Obtain the total number of homicides and the number of unsolved homicides.  
```{r}
homicide_total = 
        homicide_df %>% 
        group_by(city_state) %>% 
        summarise(
                hom_total = n(),
                hom_unsolved = sum(disposition == "Unsolved")
        )
```
Estimate the proportion of homicides that are unsolved in the city of Baltimore, MD.
```{r}
prop.test(
        homicide_total %>% filter(city_state == "Baltimore, MD") %>% pull(hom_unsolved),
        homicide_total %>% filter(city_state == "Baltimore, MD") %>% pull(hom_total)
) %>%
        broom::tidy() %>% 
        select(estimate, conf.low, conf.high)
```
Estimate the proportion of homicides that are unsolved in all cities.  
```{r}
results_df = 
        homicide_total %>% 
        mutate(
                prop_tests = map2(.x = hom_unsolved, .y = hom_total, ~prop.test(x = .x, n = .y)),
                tidy_tests = map(.x = prop_tests, ~broom::tidy(.x))
        ) %>% 
        select(-prop_tests) %>% 
        unnest(tidy_tests) %>% 
        select(city_state, estimate, conf.low, conf.high)
```
Creat a plot.  
```{r}
results_df %>% 
        mutate(
                city_state = fct_reorder(city_state, estimate)
        ) %>% 
        ggplot(aes(x = city_state, y = estimate)) +
        geom_point() +
        geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```



